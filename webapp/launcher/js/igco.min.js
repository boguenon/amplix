function m$B2(t,a){var l=this;l.ind=t,l.rowdata=a,l.ellipses=[],l.label=$("<div class='bblabel'></div>"),l.html=$("<div class='bbbox'></div>"),l.ind.container.append(l.html),l.paper=new Raphael(l.html[0]),l.html.append(l.label),l.invalidate=-1,l.validateData.call(l)}function m$Bl(t){this.parent=t,this.mv=null,this.colorset=[.23,.4,.3],this.initVariables()}m$B2.prototype={validateData:function(){var t,a,l=this,e=l.ellipses,i=l.ind.colorset,n=l.rowdata;for(t=0;t<e.length;t++)e[t].html.remove();for(e=[],l.label.text(n.name),t=0;t<n.value.length;t++)(a={}).color=i[t%i.length],e.push(a);l.ellipses=e,l.validateDisplay()},validateDisplay:function(){var t=this;-1<t.invalidate&&clearTimeout(t.invalidate),setTimeout(function(){t.updateDisplay.call(t)},100)},updateDisplay:function(){var t,a,l,e,i,n,h,s,o,r,m,c,p=this,u=p.ind,v=p.html,b=IG$.j$ext._w(v),d=IG$.j$ext._h(v),f=p.rowdata,x=p.ellipses,$=u.mcalc.max,g=null==u.mv?u.mcalc.min:u.mv>u.mcalc.min?u.mv:u.mcalc.min,y=p.label;if(0<b&&0<d){if((o=p.paper).clear(),o.setSize(b,d),x&&0<x.length){for(e=Math.min(b,d),a=$==g?$:$-g,s=0;s<x.length;s++)h=0==s?f.value[s]:h+f.value[s];for(n=(h-g)/a*(.8*e)+.1*e,s=0;s<x.length;s++)i=0==s?f.value[s]:i+f.value[s],l=Math.sqrt(n*n*i/h),(t=x[s]).x=b/2,t.y=d/2,t.radius=l/2;for(s=x.length-1;0<=s;s--)r=(t=x[s]).x,m=t.y,c=t.radius,hue=t.color,t.circle=o.set(o.ellipse(r,m+c-c/5,0,0).attr({fill:"rhsb("+hue+", 1, .25)-hsb("+hue+", 1, .25)",stroke:"none",opacity:0}).animate({rx:c,ry:c/2},400,"<"),o.ellipse(r,m,0,0).attr({fill:"r(.5,.9)hsb("+hue+", 1, .75)-hsb("+hue+", .5, .25)",stroke:"none"}).animate({rx:c,ry:c},400,"<"),o.ellipse(r,m,0,0).attr({stroke:"none",fill:"r(.5,.1)#ccc-#ccc",opacity:0}).animate({rx:c-c/5,ry:c-c/20},400,"<"))}p.label.css({top:d-y.height()-4,left:(b-IG$.j$ext._w(p.label))/2})}}},m$Bl.prototype={initVariables:function(){var t=this;t.ex=[],t.mx=[],t.bubbles=[],t.mcalc={},t.container=$("<div class='bbmain'></div>").appendTo(t.parent)},initControl:function(){var t,a=this.bubbles;for(t=0;t<a.length;t++)a[t].html.remove();a=[]},loadData:function(t){var a,l,e,i,n,h,s,o,r=this,m=r.ea,c=r.ma,p=r.mcalc;if(t&&0<t.length&&m&&0<m.length&&c&&0<c.length){for(a=0;a<c.length;a++)c[a].max=0,c[a].min=0;for(a=0;a<t.length;a++){for(i="",h=[],l=0;l<m.length;l++)e=m[l].i,i=0==l?t[a][e]:i+" "+t[a][e];for(l=0;l<c.length;l++)e=c[l].i,n=Number(t[a][e]),0==a?(c[l].min=n,c[l].max=n):(c[l].min=Math.min(c[l].min,n),c[l].max=Math.max(c[l].max,n)),s=0==l?n:s+n,h.push(n);0==a?(p.min=s,p.max=s):(p.min=Math.min(p.min,s),p.max=Math.max(p.max,s)),o=new m$B2(r,{name:i,value:h}),r.bubbles.push(o)}r.validateControl()}},validateControl:function(){var t,a,l,e,i,n=$(this.parent),h=IG$.j$ext._w(n),s=IG$.j$ext._h(n),o=this.bubbles;if(0<h&&0<s&&o&&0<o.length)for(i=0,l=h/o.length,e=s,a=0;a<o.length;a++)(t=o[a]).html.css({left:i,top:0,position:"absolute"}),IG$.j$ext._w(t.html,l),IG$.j$ext._h(t.html,e),t.validateDisplay.call(t),i+=l}};
IG$.m$CompMatrix=function(){this.xField=null,this.xFieldName=null,this.yField=null,this.yFieldName=null,this.compVal,this.dataSet=null,this.toString=function(){return this.xFieldName+", "+this.yFieldName+" : "+this.compVal}},IG$.compMatrixPlotCell=function(){var n,t,i=window.bowser,e=window&&window.SVGAngle||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1");this.hasCanvas=!e&&!i.msie,this.compItem,this.xMin,this.xMax,this.yMin,this.yMax,this.xRange,this.yRange,this.cr1=0,this.cr2=0,this.selected,this.width,this.height,this.html=$('<div class="matrixchart"></div>'),1==this.hasCanvas&&(this.canvas=$("<canvas></canvas>"),this.canvas.appendTo(this.html)),this.updateExtremes=function(){if(this.compItem&&this.compItem.dataSet){for(this.xMin=Number.MAX_VALUE,this.yMin=Number.MAX_VALUE,this.xMax=Number.MIN_VALUE,this.yMax=Number.MIN_VALUE,n=0;n<this.compItem.dataSet.length;n++)t=this.compItem.dataSet[n],this.xMin=Math.min(this.xMin,t[this.compItem.xField]),this.yMin=Math.min(this.yMin,t[this.compItem.yField]),this.xMax=Math.max(this.xMax,t[this.compItem.xField]),this.yMax=Math.max(this.yMax,t[this.compItem.yField]);this.xRange=this.xMax-this.xMin,this.yRange=this.yMax-this.yMin}},this.computeX=function(t){var i=t[this.compItem.xField];return 1-(this.xMax-i)/this.xRange},this.computeY=function(t){var i=t[this.compItem.yField];return 1-(this.yMax-i)/this.yRange},this.updatePlot=function(){var t,i,e,s;for(this.plotData=[],t=0;t<this.compItem.dataSet.length;t++)i=this.compItem.dataSet[t],e=this.computeX(i),s=this.computeY(i),this.plotData.push([e,s]);this.drawPlot()},this.drawPlot=function(){this.width=this.html.innerWidth(),this.height=this.html.innerHeight();var t,i={};for(t=this.compItem.compVal>this.cr2?"rgba(0,0,255,":this.compItem.compVal>this.cr1?"rgba(150,150,150,":"rgba(255,0,0,",1==this.hasCanvas?(this.canvas.width=this.width,this.canvas.height=this.height,this.ctx=this.canvas[0].getContext("2d"),this.ctx.scale(1,1),this.ctx.fillStyle="rgb(255,255,255)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.strokeStyle="#5F5F5F",this.ctx.lineWidth=1,this.ctx.fillStyle=t+".5)"):this.paper?this.paper.clear():this.paper=Raphael(this.html[0],0,0,this.width,this.height),n=0;n<this.plotData.length;n++){var e,s=this.plotData[n],h=0==isNaN(s[0])?s[0]*this.width:0,a=0==isNaN(s[1])?(1-s[1])*this.height:this.height,l=Math.floor(h),o=Math.floor(a);i[e=(l-=l%5)+","+(o-=o%5)]||(1==this.hasCanvas?(this.ctx.beginPath(),this.ctx.arc(h,a,1,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),i[e]={obj:!0,mbody:0}):(i[e]={obj:this.paper.circle(h,a,2),mbody:0},i[e].obj.attr("fill",t+"0.5)")))}i=null},this.updateDispList=function(t,i){this.drawPlot()},this.commitProps=function(){this.updateExtremes(),this.updatePlot()}},IG$.ComparisonMatrix=function(t,i){this.compItems=null,this.cells=[],this.parent=t,this.config=i,this.textFields=[],this.showLabels=i.showLabels||!0,this.cr1=null==i.cr1||void 0===i.cr1?0:i.cr1,this.cr2=null==i.cr2||void 0===i.cr2?0:i.cr2,this.container=$('<div class="matrixcontainer"></div>'),this.container.appendTo(this.parent),this.labelhtml=$('<div class="matrixlabel"></div>'),this.labelhtml.css({position:"absolute",top:"0px",left:"0px",width:"0px",height:"0px"}),this.labelhtml.appendTo(this.parent),this.isDirty=!1,this.detailviewer=$('<div class="detailviewer"></div>'),this.detailviewer.css({position:"absolute",top:10,left:10,width:100,height:100,margin:0,padding:0,backgroundColor:"#ececec",borderColor:"#222222",display:"none"}),this.detailviewer.appendTo(this.parent),this.detailviewer.bind("click",function(){$(this).fadeOut()}),this.detailcontainer=$('<div class="detailmatrixplot"></div>'),this.detailcontainer.css({position:"absolute",margin:"20 0 0 0",padding:0,top:0,left:0,right:0,bottom:0}),this.uid=0,this.detailcontainer.appendTo(this.detailviewer);var e=$('<div class="detailmatrixclosebtn"></div>'),s=this.detailviewer;e.css({position:"absolute",top:2,width:16,height:16,right:2}),this.detailviewer.append(e),e.bind({click:function(){s.fadeOut()}}),this.correlationCoefficient=function(t,i,e){var s,h,a=t.length,l=0,o=0,n=0,r=0,c=0;for(h=0;h<t.length;h++){var d=(s=t[h])[i],m=s[e];l+=d,o+=m,n+=Math.pow(d,2),r+=Math.pow(m,2),c+=d*m}return(a*c-l*o)/(Math.sqrt(a*n-Math.pow(l,2))*Math.sqrt(a*r-Math.pow(o,2)))},this.comparisonFunction=this.correlationCoefficient,this.generateComparisonStatistics=function(){if(this.compItems=[],0!=this.fields.length&&null!=this.dataSet&&0!=this.dataSet.length)for(var t=this.fields.length,i=0;i<t;i++)for(var e=0;e<i+1;e++)if(i!=e){var s=new IG$.m$CompMatrix;s.xFieldName=this.fields[i],s.xField=i,s.yFieldName=this.fields[e],s.yField=e,s.compVal=this.comparisonFunction.call(this,this.dataSet,s.xField,s.yField),this.compItems.push(s),0}},this.createOrRemoveCells=function(){var t,i=this,e=this.compItems.length;for(this.matrixitems={};this.cells.length<e;){var s=new IG$.compMatrixPlotCell;s.html.css({border:"1px solid #a5a5a5",width:200,height:200,position:"absolute",padding:0}),s.html.appendTo(this.container),t="matrixplot"+this.uid,s.html[0].id=t,this.uid++,s.html.bind({click:function(){i.drawDetailPlot.call(i,this)}}),this.cells.push(s),this.matrixitems[t]=s}for(;e<this.cells.length;){this.cells.pop().remove()}},this.updateTextFields=function(){var t,i,e=this.fields.length;for(t=0;t<e;t++)this.textFields.length<t+1&&((i=$('<div class="matrixtextfield"></div>')).css({fontSize:"0.8em",padding:"0 0 0 3",margin:0,position:"absolute",width:130}),this.textFields.push(i),i.appendTo(this.labelhtml)),this.textFields[t][0].innerText=this.fields[t];for(;e<this.textFields.length;){textFields.pop();this.textFieldToRemove.remove()}},this.layoutTextFields=function(){var t,i,e,s,h,a=this.textFields.length;if(0<a)for(t=this.textFields[0].height(),i=0;i<a;i++)e=this.textFields[i],s=i*this.actualCellSize+1,h=0==i?0:(i-1)*this.actualCellSize+t,e.css({left:s,top:h})},this.layoutCells=function(){var t=0;if(this.showLabels&&0<this.textFields.length){var i=this.textFields[0];t=i.position().top+i.height()}for(var e=this.fields.length,s=0,h=0;h<e;h++)for(var a=0;a<h+1;a++)if(h!=a){var l=this.compItems[s],o=this.cells[s];l.dataSet=this.dataSet,o.compItem=l,o.selected=l==this.selectedItem;var n;n=l.xField+"\n"+l.yField+"\n"+l.compVal,o.toolTip=n;var r=a*this.actualCellSize,c=(h-1)*this.actualCellSize+t;o.html.css({left:r,top:c,width:this.actualCellSize,height:this.actualCellSize}),o.cr1=this.cr1,o.cr2=this.cr2,1==this.isDirty?o.commitProps.call(o):o.updateDispList.call(o),s++}},this.computeCellSize=function(t,i){var e=t,s=i;return s=1==this.showLabels&&0<this.textFields.length?(e=t-this.textFields[this.textFields.length-1].width(),i-this.textFields[0].height()):(e=t,i),Math.min(e,s)/(this.fields.length-1)},this.updateDispList=function(){var t=$(this.parent),i=t.innerWidth(),e=t.innerHeight();this.container.css({width:i,height:e}),this.actualCellSize=this.computeCellSize(i,e),this.showLabels&&0<this.textFields.length&&this.layoutTextFields(),this.layoutCells()},this.commitProp=function(){this.isDirty=!0,this.generateComparisonStatistics(),this.createOrRemoveCells(),this.updateTextFields(),this.updateDispList(),this.isDirty=!1}},IG$.ComparisonMatrix.prototype.drawDetailPlot=function(t){var i=this.matrixitems[t.id],e=i.compItem.compVal>this.cr2?"rgba(0,0,255,.5)":i.compItem.compVal>this.cr1?"rgba(150,150,150,.5)":"rgba(255,0,0,0.5)";if(i){var s={chart:{renderTo:this.detailcontainer[0],defaultSeriesType:"scatter",zoomType:"xy"},title:{text:i.compItem.xFieldName+" vs. "+i.compItem.yFieldName},xAxis:{title:{enabled:!0,text:i.compItem.xFieldName},startOnTick:!0,endOnTick:!0,showLastLabel:!0,min:0,max:1},yAxis:{title:{text:i.compItem.yFieldName},min:0,max:1},tooltip:{formatter:function(){return this.x+", "+this.y}},legend:{enabled:!1,layout:"vertical",align:"left",verticalAlign:"top",floating:!0,backgroundColor:"#FFFFFF",borderWidth:1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}}}},series:[{name:"comparison",color:e,data:i.plotData}]},h=$(this.parent),a=h.width(),l=h.height(),o=.85*Math.min(l,a);this.detailviewer.css({left:a-o-10,top:5,width:o,height:o}),this.detailviewer.show(),this.plotdetail=new Highcharts.Chart(s)}};
IG$.c$NatChart=function(t,a,n){this.owner=t,this.sheetoption=a,this.cop=n,this.initialize()},IG$.c$NatChart.prototype={initialize:function(){var t=this,a=t.owner;$("<div></div>").appendTo(a);t.margin={top:19.5,right:19.5,bottom:19.5,left:39.5},t.width=IG$.j$ext._w(a),t.height=IG$.j$ext._h(a)},loadData:function(t){var a,n,e,r,o,i,d,s,l=this,c=(l.owner,l.width,l.height,l.margin,$("<div><div>").appendTo(l.owner),l.bb,t._tabledata),f=t.colfix,m=t.rowfix,u=0<c.length?c[0].length:0,h=[],p={},b=f-1,g=-1<b-1?b-1:b,x=-1<g-1?g-1:g,v=f,w=f+1<u?f+1:v,M=v+1<u?v+1:v,y={},N=0,C=[],_=[{m:0,M:0},{m:0,M:0},{m:0,M:0}];if(x=-1<(d=l.findCols(l.cop.nat_timefield,f))?d:x,b=-1<(d=l.findCols(l.cop.nat_datafield,f))?d:b,g=-1<(d=l.findCols(l.cop.nat_groupfield,f))?d:g,v=-1<(d=l.findCols(l.cop.nat_xdata,f))?d:v,w=-1<(d=l.findCols(l.cop.nat_ydata,f))?d:w,M=-1<(d=l.findCols(l.cop.nat_vdata,f))?d:M,0<f){for(n=m;n<c.length;n++)y[i=c[n][x].code||""]||(C.push(i),y[i]=1);for(N=C.length,C=C.sort(),y={},n=0;n<C.length;n++)y[C[n]]=n;for(n=m;n<c.length;n++){if(p[a=c[n][b].code])r=p[a];else{for(r={name:c[n][b].code,region:c[n][g].code,bbdata1:[],bbdata2:[],bbdata3:[]},e=0;e<C.length;e++)r.bbdata1.push([e,0]),r.bbdata2.push([e,0]),r.bbdata3.push([e,0]);p[a]=r,h.push(r)}o=-1,void 0!==y[i=c[n][x].code||""]&&(o=y[i]),s=Number(c[n][v].code)||0,s=isNaN(s)?0:s,r.bbdata1[o][1]=s,_[0].m=Math.min(s,_[0].m),_[0].M=Math.max(s,_[0].M),s=Number(c[n][w].code)||0,s=isNaN(s)?0:s,r.bbdata2[o][1]=s,_[1].m=Math.min(s,_[1].m),_[1].M=Math.max(s,_[1].M),s=Number(c[n][M].code)||0,s=isNaN(s)?0:s,r.bbdata3[o][1]=s,_[2].m=Math.min(s,_[2].m),_[2].M=Math.max(s,_[2].M)}}if(_)for(n=0;n<_.length;n++)_[n].m==_[n].M&&(_[n].M=_[n].m+10);l.segnames=y,l.seglists=C,l.segmax=N,l.fs=_,l.dt=h,l.drawChart()},drawChart:function(){var t,e=this,n=(e.owner,e.dt),a=e.fs;function r(t){return t.bbdata1}function o(t){return t.bbdata2}function i(t){return t.bbdata3}function d(t){return t.name}e.owner.empty(),t=$("<div><div>").appendTo(e.owner);var s,l=e.margin,c=IG$.j$ext._w(e.owner)-l.right-l.left,f=IG$.j$ext._h(e.owner)-l.top-l.bottom,m=d3.scale.linear().domain([a[0].m,a[0].M]).range([0,c]),u=d3.scale.linear().domain([a[1].m,a[1].M]).range([f,0]),h=d3.scale.sqrt().domain([a[2].m,a[2].M]).range([0,40]),p=d3.scale.category10(),b=d3.svg.axis().orient("bottom").scale(m).ticks(12,d3.format(",d")),g=d3.svg.axis().scale(u).orient("left");(s=this.vis=d3.select(t[0]).append("svg").attr("width",c+l.left+l.right).attr("height",f+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")")).append("g").attr("class","d3-nation-x d3-nation-axis").attr("transform","translate(0,"+f+")").call(b),s.append("g").attr("class","d3-nation-y d3-nation-axis").call(g),s.append("text").attr("class","d3-nation-x d3-nation-label").attr("text-anchor","end").attr("x",c).attr("y",f-6),s.append("text").attr("class","d3-nation-y d3-nation-label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)");var x,v,w=s.append("text").attr("class","d3-nation-year d3-nation-label").attr("text-anchor","end").attr("y",f-24).attr("x",c),M=d3.bisector(function(t){return t[0]}),y=s.append("g").attr("class","d3-nation-dots").selectAll(".dot").data(I(0)).enter();function N(t){t.attr("cx",function(t){var a=m(r(t));return a=a<0?0:a}).attr("cy",function(t){var a=u(o(t));return a=a<0?0:a}).attr("r",function(t){var a=h(i(t));return a=a<0?0:a})}function C(t){t.attr("x",function(t){var a,n=m(r(t));return(n=n<0?0:n)-(a=(a=h(i(t)))<0?0:a)}).attr("y",function(t){var a=u(o(t));return a=a<0?0:a})}function _(t,a){return i(a)-i(t)}function G(t){v.data(I(t),d).call(N).sort(_),x.data(I(t),d).call(C).sort(_),w.text(e.seglists[Math.floor(t)])}function I(a){return n.map(function(t){return{name:t.name,region:t.region,bbdata1:j(t.bbdata1,a),bbdata2:j(t.bbdata2,a),bbdata3:j(t.bbdata3,a)}})}function j(t,a){var n=M.left(t,a,0,t.length-1),e=t[n];if(0<n){var r=t[n-1],o=(a-e[0])/(r[0]-e[0]);return e[1]*(1-o)+r[1]*o}return e[1]}(v=y.append("circle").attr("class","d3-nation-dot").style("fill",function(t){return p(t.region)}).call(N).sort(_)).append("title").text(function(t){return t.name}),x=y.append("text").text(function(t){return t.name}).call(C),s.transition().duration(800*e.segmax).ease("linear").tween("year",function(){var a=d3.interpolateNumber(0,e.segmax-1);return function(t){G(a(t))}}).each("end",function(){var t=w.node().getBBox(),a=d3.scale.linear().domain([0,e.segmax]).range([t.x+10,t.x+t.width-10]).clamp(!0);function n(){G(a.invert(d3.mouse(this)[0]))}s.append("rect").attr("class","d3-nation-overlay").attr("x",t.x).attr("y",t.y).attr("width",t.width).attr("height",t.height).on("mouseover",function(){w.classed("active",!0)}).on("mouseout",function(){w.classed("active",!1)}).on("mousemove",n).on("touchmove",n)})},findCols:function(t,a){var n,e=this.sheetoption,r=-1;for(n=0;n<e.model.rows.length;n++)if(e.model.rows[n].name==t){r=n;break}if(-1==r&&0<e.model.measures.length)for(n=0;n<e.model.measures.length;n++)if(e.model.measures[n].name==t){r=n+a;break}return r}};
window.d3&&(d3.sankey=function(){var t={},u=24,i=8,f=[1,1],a=[],s=[];function r(){function t(n,t){return n.source.y-t.source.y}function r(n,t){return n.target.y-t.target.y}a.forEach(function(n){n.sourceLinks.sort(r),n.targetLinks.sort(t)}),a.forEach(function(n){var t=0,r=0;n.sourceLinks.forEach(function(n){n.sy=t,t+=n.dy}),n.targetLinks.forEach(function(n){n.ty=r,r+=n.dy})})}function y(n){return n.y+n.dy/2}function h(n){return n.value}return t.nodeWidth=function(n){return arguments.length?(u=+n,t):u},t.nodePadding=function(n){return arguments.length?(i=+n,t):i},t.nodes=function(n){return arguments.length?(a=n,t):a},t.links=function(n){return arguments.length?(s=n,t):s},t.size=function(n){return arguments.length?(f=n,t):f},t.layout=function(n){return a.forEach(function(n){n.sourceLinks=[],n.targetLinks=[]}),s.forEach(function(n){var t=n.source,r=n.target;"number"==typeof t&&(t=n.source=a[n.source]),"number"==typeof r&&(r=n.target=a[n.target]),t.sourceLinks.push(n),r.targetLinks.push(n)}),a.forEach(function(n){n.value=Math.max(d3.sum(n.sourceLinks,h),d3.sum(n.targetLinks,h))}),function(){var t,n=a,r=0;for(;n.length;)t=[],n.forEach(function(n){n.x=r,n.dx=u,n.sourceLinks.forEach(function(n){t.push(n.target)})}),n=t,++r;(function(t){a.forEach(function(n){n.sourceLinks.length||(n.x=t-1)})})(r),function(t){a.forEach(function(n){n.x*=t})}((width-u)/(r-1))}(),function(n){var t=d3.nest().key(function(n){return n.x}).sortKeys(d3.ascending).entries(a).map(function(n){return n.values});(function(){var r=d3.min(t,function(n){return(f[1]-(n.length-1)*i)/d3.sum(n,h)});t.forEach(function(n){n.forEach(function(n,t){n.y=t,n.dy=n.value*r})}),s.forEach(function(n){n.dy=n.value*r})})(),e();for(var r=1;0<n;--n)o(r*=.99),e(),u(r),e();function u(r){function u(n){return y(n.source)*n.value}t.forEach(function(n,t){n.forEach(function(n){if(n.targetLinks.length){var t=d3.sum(n.targetLinks,u)/d3.sum(n.targetLinks,h);n.y+=(t-y(n))*r}})})}function o(r){function u(n){return y(n.target)*n.value}t.slice().reverse().forEach(function(n){n.forEach(function(n){if(n.sourceLinks.length){var t=d3.sum(n.sourceLinks,u)/d3.sum(n.sourceLinks,h);n.y+=(t-y(n))*r}})})}function e(){t.forEach(function(n){var t,r,u,o=0,e=n.length;for(n.sort(c),u=0;u<e;++u)0<(r=o-(t=n[u]).y)&&(t.y+=r),o=t.y+t.dy+i;if(0<(r=o-i-f[1]))for(o=t.y-=r,u=e-2;0<=u;--u)0<(r=(t=n[u]).y+t.dy+i-o)&&(t.y-=r),o=t.y})}function c(n,t){return n.y-t.y}}(n),r(),t},t.relayout=function(){return r(),t},t.link=function(){var f=.5;function t(n){var t=n.source.x+n.source.dx,r=n.target.x,u=d3.interpolateNumber(t,r),o=u(f),e=u(1-f),c=n.source.y+n.sy+n.dy/2,i=n.target.y+n.ty+n.dy/2;return"M"+t+","+c+"C"+o+","+c+" "+e+","+i+" "+r+","+i}return t.curvature=function(n){return arguments.length?(f=+n,t):f},t},t});
IG$.v$Sankey=function(t){this.owner=t,this.bb=null,this.initialize()},IG$.v$Sankey.prototype={initialize:function(){var t,e=this,n=e.owner,a=$("<div></div>").appendTo(n);e.width=IG$.j$ext._w(n),e.height=IG$.j$ext._h(n),e.margin={top:1,right:1,bottom:6,left:1},this.bb||(this.bb=IG$.c$BullChartV(),IG$.j$ext._w(this.bb,e.width-e.margin.right-e.margin.left),IG$.j$ext._h(this.bb,e.height-e.margin.top-e.margin.bottom)),t=$("<ul></ul>").appendTo(a),e.gtp=t,t=$("<li></li>").appendTo(e.gtp),$("<div>Ranges</div>").appendTo(t),e.ranges=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(e.gtp),$("<div>Measures</div>").appendTo(t),e.measures=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(e.gtp),$("<div>Markers</div>").appendTo(t),e.markers=$("<combobox></combobox>").appendTo(t)},loadData:function(t){var e,n,a,r=this,o=(r.owner,r.width),i=r.height,d=r.margin,l=$("<div><div>").appendTo(r.owner);d3.select(l[0]).append("svg").attr("width",o+d.left+d.right).attr("height",i+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")");e={nodes:[],lines:[]};var s,p,h,u,c=t._tabledata,g=t.colfix,f=t.rowfix,m=(0<c.length&&c[0].length,0+g),b={};for(n=0;n<g;n++)mapinfo.push({});for(n=f;n<c.length;n++)for(a=0;a<g;a++)b[s=c[n][a].code]||(h=e.nodes.length,b[s]=h,e.nodes.push(s));for(n=f;n<c.length;n++)for(a=0;a<g;a++)s=c[n][a].code,a+1<g&&(p=c[n][a+1].code,u={source:b[s],target:b[p],value:Number(c[n][m].code)},e.lines.push(u));r.drawChart(e)},drawChart:function(t){function e(t){return n(t)+" TWh"}var n=d3.format(",.0f"),a=d3.scale.category20(),r=d3.sankey().nodeWidth(15).nodePadding(10).size([width,height]),o=r.link();r.nodes(t.nodes).links(t.links).layout(32);var i=svg.append("g").selectAll(".link").data(t.links).enter().append("path").attr("class","link").attr("d",o).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy});i.append("title").text(function(t){return t.source.name+" �� "+t.target.name+"\n"+e(t.value)});var d=svg.append("g").selectAll(".node").data(t.nodes).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).call(d3.behavior.drag().origin(function(t){return t}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",function(t){d3.select(this).attr("transform","translate("+t.x+","+(t.y=Math.max(0,Math.min(height-t.dy,d3.event.y)))+")"),r.relayout(),i.attr("d",o)}));d.append("rect").attr("height",function(t){return t.dy}).attr("width",r.nodeWidth()).style("fill",function(t){return t.color=a(t.name.replace(/ .*/,""))}).style("stroke",function(t){return d3.rgb(t.color).darker(2)}).append("title").text(function(t){return t.name+"\n"+e(t.value)}),d.append("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<width/2}).attr("x",6+r.nodeWidth()).attr("text-anchor","start")}};
function randomize(t){return t.randomizer||(t.randomizer=randomizer(t)),t.ranges=t.ranges.map(t.randomizer),t.markers=t.markers.map(t.randomizer),t.measures=t.measures.map(t.randomizer),t}function randomizer(t){var r=.2*d3.max(t.ranges);return function(t){return Math.max(0,t+r*(Math.random()-.5))}}function bulletRanges(t){return t.ranges}function bulletMarkers(t){return t.markers}function bulletMeasures(t){return t.measures}function bulletTranslate(r){return function(t){return"translate("+r(t)+",0)"}}function bulletWidth(r){var a=r(0);return function(t){return Math.abs(r(t)-a)}}IG$.c$BulChart=function(t){this.owner=t,this.bb=null,this.initialize()},IG$.c$BulChart.prototype={initialize:function(){var t,r=this,a=r.owner,e=$("<div></div>").appendTo(a);r.width=IG$.j$ext._w(a),r.height=IG$.j$ext._h(a),r.margin={top:5,right:40,bottom:20,left:120},r.bb||(r.bb=IG$.c$BullChartV(),IG$.j$ext._w(r.bb,r.width-r.margin.right-r.margin.left),IG$.j$ext._h(r.bb,r.height-r.margin.top-r.margin.bottom)),t=$("<ul></ul>").appendTo(e),r.gtp=t,t=$("<li></li>").appendTo(r.gtp),$("<div>Ranges</div>").appendTo(t),r.ranges=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(r.gtp),$("<div>Measures</div>").appendTo(t),r.measures=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(r.gtp),$("<div>Markers</div>").appendTo(t),r.markers=$("<combobox></combobox>").appendTo(t)},loadData:function(t){var r,a=this,e=(a.owner,a.width),n=a.height,i=a.margin,l=$("<div><div>").appendTo(a.owner),o=d3.select(l[0]).selectAll("svg"),s=a.bb;r=a.getData(),o.data(r).enter().append("svg").attr("class","bullet").attr("width",e).attr("height",n).append("g").attr("transform","translate("+i.left+","+i.top+")").call(s);var u=o.append("g").attr("text-anchor","end").attr("transform","translate(-6,"+(n-i.top-i.bottom)/2+")");u.append("text").attr("class","title").text(function(t){return t.title}),u.append("text").attr("class","subtitle").attr("dy","1em").text(function(t){return t.subtitle}),a.vis=o,a.title=u,s.duration(1e3)},drawChart:function(){var t=this.bb;vis.datum(randomize).call(t)},getData:function(){var t,r,a,e,n,i,l,o,s=[],u=mresult._tabledata,d=mresult.colfix,c=mresult.rowfix,h=0<u.length?u[0].length:0,m={},g={};for(t=d;t<h;t++);for(t=c;t<u.length;t++){for(a={title:null,ranges:[],measures:[],markers:[]},o=l=null,r=0;r<h;r++)r<d?(e=u[t][r].text||u[t][r].code,a.title=0==t?e:a.title+" "+e):(e=Number(u[t][r].code),n=r==d?e:Math.max(n,e),i=r==d?e:Math.min(i,e),1==m[r]&&(o=null==l?l=e:(l=Math.min(l,e),Math.max(o,e))),1==g[r]&&a.markers.push(e));a.ranges=[i,void 0,n],a.measures=[l,o],s.push(a)}return s}},IG$.c$BullChartV=function(){var r="left",f=!1,x=0,v=bulletRanges,$=bulletMarkers,y=bulletMeasures,w=380,k=30,T=null;function a(t){t.each(function(t,r){var a=v.call(this,t,r).slice().sort(d3.descending),e=$.call(this,t,r).slice().sort(d3.descending),n=y.call(this,t,r).slice().sort(d3.descending),i=d3.select(this),l=d3.scale.linear().domain([0,Math.max(a[0],e[0],n[0])]).range(f?[w,0]:[0,w]),o=this.__chart__||d3.scale.linear().domain([0,1/0]).range(l.range());this.__chart__=l;var s=bulletWidth(o),u=bulletWidth(l),d=i.selectAll("rect.range").data(a);d.enter().append("svg:rect").attr("class",function(t,r){return"range s"+r}).attr("width",s).attr("height",k).attr("x",f?o:0).transition().duration(x).attr("width",u).attr("x",f?l:0),d.transition().duration(x).attr("x",f?l:0).attr("width",u).attr("height",k);var c=i.selectAll("rect.measure").data(n);c.enter().append("svg:rect").attr("class",function(t,r){return"measure s"+r}).attr("width",s).attr("height",k/3).attr("x",f?o:0).attr("y",k/3).transition().duration(x).attr("width",u).attr("x",f?l:0),c.transition().duration(x).attr("width",u).attr("height",k/3).attr("x",f?l:0).attr("y",k/3);var h=i.selectAll("line.marker").data(e);h.enter().append("svg:line").attr("class","marker").attr("x1",o).attr("x2",o).attr("y1",k/6).attr("y2",5*k/6).transition().duration(x).attr("x1",l).attr("x2",l),h.transition().duration(x).attr("x1",l).attr("x2",l).attr("y1",k/6).attr("y2",5*k/6);var m=T||l.tickFormat(8),g=i.selectAll("g.tick").data(l.ticks(8),function(t){return this.textContent||m(t)}),p=g.enter().append("svg:g").attr("class","tick").attr("transform",bulletTranslate(o)).style("opacity",1e-6);p.append("svg:line").attr("y1",k).attr("y2",7*k/6),p.append("svg:text").attr("text-anchor","middle").attr("dy","1em").attr("y",7*k/6).text(m),p.transition().duration(x).attr("transform",bulletTranslate(l)).style("opacity",1);var b=g.transition().duration(x).attr("transform",bulletTranslate(l)).style("opacity",1);b.select("line").attr("y1",k).attr("y2",7*k/6),b.select("text").attr("y",7*k/6),g.exit().transition().duration(x).attr("transform",bulletTranslate(l)).style("opacity",1e-6).remove()}),d3.timer.flush()}return a.orient=function(t){return arguments.length?(f="right"==(r=t)||"bottom"==r,a):r},a.ranges=function(t){return arguments.length?(v=t,a):v},a.markers=function(t){return arguments.length?($=t,a):$},a.measures=function(t){return arguments.length?(y=t,a):y},a.width=function(t){return arguments.length?(w=t,a):w},a.height=function(t){return arguments.length?(k=t,a):k},a.tickFormat=function(t){return arguments.length?(T=t,a):T},a.duration=function(t){return arguments.length?(x=t,a):x},a};